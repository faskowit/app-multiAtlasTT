#!/bin/bash

# dependencies:
# python2.7 with numpy and nibabel
# FreeSurfer
# altas GCS data, which is automatically downloaded from figShare

####################################################################
####################################################################

##for testing
#set -e
#INPUT_DIR=$1

####################################################################
####################################################################
# capture inputs from config
# TODO: capture input about which atlas to create. right now its  
# setup to just do all 10

INPUT_DIR=`jq -r '.fsin' config.json`
#OUTPUT_DIR=`jq -r '' config.json`
OUTPUT_DIR='out'
#FS_VERSION=`jq -r '.' config.json`
FS_VERSION='6p0'
atlasList=`jq -r '.atlas' config.json`

if [[ ${atlasList} == 'null' ]] || [[ ${atlasList} == 'all' ]] 
then
    atlasList="gordon333 nspn500 yeo17 yeo17dil hcp-mmp schaefer100-yeo17 schaefer200-yeo17 schaefer400-yeo17 schaefer600-yeo17 schaefer800-yeo17 schaefer1000-yeo17"
fi
export atlasList 

####################################################################
####################################################################
# setup FREESURFER
# TODO: setup in a more general way. right now, this will work if the
# modules enviorment system being used

# note, make sure you use the verison of FreeSurfer that you 
# actually want...
if [[ -z ${FREESURFER_HOME} ]]
then
    module load freesurfer
fi

####################################################################
####################################################################

export atlasBaseDir=${PWD}/atlas_data
export scriptBaseDir=${PWD}

# make a list from these options: 
# nspn500 gordon333 yeo17 hcp-mmp schaefer100-yeo17 
# schaefer200-yeo17 schaefer400-yeo17 schaefer600-yeo17 schaefer800-yeo17 
# schaefer1000-yeo17

# actually read in atlast list from user input
# export atlasList="nspn500 gordon333 yeo17 hcp-mmp schaefer100-yeo17 schaefer200-yeo17 schaefer400-yeo17 schaefer600-yeo17 schaefer800-yeo17 schaefer1000-yeo17"

####################################################################
####################################################################

mkdir -p ${PWD}/${OUTPUT_DIR}

# fetch the data, if it does not already exist
gcsMissing=0
gcsFiles=''

for ii in ${atlasList}
do
    for hemi in lh rh
    do
        currGCS=${atlasBaseDir}/${ii}/${hemi}.${ii}_${FS_VERSION}.gcs
        if [[ ! -f ${currGCS} ]]
        then
	    gcsMissing=1
	    break
        fi
    done
done

if [[ ${gcsMissing} -eq 1 ]]
then
    wget -q -O figShareDL https://ndownloader.figshare.com/files/11492165
    tar -vxf figShareDL
    rm figShareDL
else
    echo "gcs data already present"
fi

####################################################################
####################################################################
# subject variables

#subj="my_subject"
#inputFSDir="/path/to/freesurfer/${subj}/"
#outputDir="/output/to/somwhere/${subj}/"
#mkdir -p ${outputDir}

####################################################################
####################################################################
# go into the folder where we also want output and setup notes file!

touch ${PWD}/${OUTPUT_DIR}/log.txt

echo "running maTT2"
# run it
cmd="${scriptBaseDir}/src/maTT2_applyGCS.sh \
        -d ${INPUT_DIR} \
        -o ${PWD}/${OUTPUT_DIR}/ \
        -f ${FS_VERSION} \
    "
echo $cmd 
eval $cmd | tee -a ${PWD}/${OUTPUT_DIR}/log.txt

echo "finished maTT2 with status: $?"





















